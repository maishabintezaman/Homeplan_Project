<?php
session_start();
if (empty($_SESSION['user_id']) || ($_SESSION['role'] ?? '') !== 'client') {
  header("Location: /homeplan/auth/login.php");
  exit;
}
require_once __DIR__ . '/../config/db.php';
require_once __DIR__ . '/../partials/navbar.php';

$client_id = (int)$_SESSION['user_id'];
$developer_id = (int)($_GET['developer_id'] ?? $_POST['developer_id'] ?? 0);
if ($developer_id <= 0) die("Invalid developer");

$dev = mysqli_fetch_assoc(mysqli_query($conn, "SELECT user_id, full_name FROM users WHERE user_id=$developer_id AND role='developer' LIMIT 1"));
if (!$dev) die("Developer not found");

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $area_unit = $_POST['area_unit'] ?? 'sqft';
  $area_value = (float)($_POST['area_value'] ?? 0);
  $location_text = trim($_POST['location_text'] ?? '');
  $asking_price = (float)($_POST['asking_price'] ?? 0);
  $road_width = (float)($_POST['road_width'] ?? 0);
  $ownership_type = trim($_POST['ownership_type'] ?? '');
  $notes = trim($_POST['notes'] ?? '');

  $sql = "INSERT INTO requests
          (request_type, client_id, provider_id, status, created_at,
           area_unit, area_value, location_text, asking_price, road_width, ownership_type, notes)
          VALUES
          ('developer_land', ?, ?, 'submitted', NOW(),
           ?, ?, ?, ?, ?, ?, ?)";

  $stmt = mysqli_prepare($conn, $sql);
  mysqli_stmt_bind_param($stmt, "iisssddsss",
    $client_id, $developer_id,
    $area_unit, $area_value, $location_text, $asking_price, $road_width, $ownership_type, $notes
  );
  mysqli_stmt_execute($stmt);
  mysqli_stmt_close($stmt);

  header("Location: /homeplan/client/developer_projects.php?developer_id=$developer_id");
  exit;
}
?>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Request Land</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4" style="max-width:800px;">
  <a href="/homeplan/client/developer_projects.php?developer_id=<?= (int)$developer_id ?>" class="btn btn-outline-dark mb-3">Back</a>

  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="mb-1">Request your land to: <?= htmlspecialchars($dev['full_name']) ?></h4>
      <p class="text-muted mb-3">Fill the land information and send request.</p>

      <form method="post">
        <input type="hidden" name="developer_id" value="<?= (int)$developer_id ?>">

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Area Unit</label>
            <select name="area_unit" class="form-select" required>
              <option value="katha">Katha</option>
              <option value="sqft" selected>Sqft</option>
              <option value="sqm">Sqm</option>
              <option value="decimal">Decimal</option>
            </select>
          </div>

          <div class="col-md-8">
            <label class="form-label">Land Area</label>
            <input name="area_value" type="number" step="0.01" class="form-control" required>
          </div>

          <div class="col-md-12">
            <label class="form-label">Location</label>
            <input name="location_text" class="form-control" required placeholder="Area, City, Details">
          </div>

          <div class="col-md-6">
            <label class="form-label">Asking Price (BDT)</label>
            <input name="asking_price" type="number" step="0.01" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Road Width (ft) (optional)</label>
            <input name="road_width" type="number" step="0.01" class="form-control">
          </div>

          <div class="col-md-12">
            <label class="form-label">Ownership Type (optional)</label>
            <input name="ownership_type" class="form-control" placeholder="Single / Joint / Others">
          </div>

          <div class="col-md-12">
            <label class="form-label">Expectation / Notes</label>
            <textarea name="notes" class="form-control" rows="4" placeholder="Your expectations, timeline, any details..."></textarea>
          </div>
        </div>

        <button class="btn btn-success mt-4 w-100">Send Request</button>
      </form>

    </div>
  </div>
</div>
</body>
</html>
